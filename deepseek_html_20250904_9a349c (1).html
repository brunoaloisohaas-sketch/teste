<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LF Transportes ‚Äî App de Coleta</title>
  <meta name="theme-color" content="#ffa500" />
  <style>
    :root{
      --lf-blue:#004c6d;
      --lf-blue-2:#0a6a95;
      --lf-orange:#ffa500;
      --text:#1e293b;
      --muted:#64748b;
      --card:#ffffff;
      --border:#e2e8f0;
      --bg:#f8fafc;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
    }

    .app-header{
      background: linear-gradient(90deg, var(--lf-blue), var(--lf-blue-2));
      color:#fff;
      padding:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:10;
      box-shadow:0 2px 10px rgba(0,0,0,.1);
    }
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{width:34px;height:34px;border-radius:8px;object-fit:cover;background:#fff;}
    .app-header h1{font-size:18px;margin:0;}
    .badge{
      font-size:12px;
      background:var(--lf-orange);
      color:#111;
      padding:6px 10px;
      border-radius:999px;
    }

    .container{padding:16px;max-width:1200px;margin:0 auto;}
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      padding:16px;
      border-radius:14px;
      margin-bottom:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.06);
      transition:transform .2s ease;
    }
    .card:hover{transform:translateY(-2px)}
    .card-title{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}

    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .tab-btn{
      padding:10px 14px;
      border:none;
      background:var(--lf-blue);
      color:#fff;
      border-radius:10px;
      font-weight:700;
      letter-spacing:.2px;
      transition:.25s;
    }
    .tab-btn:hover{filter:brightness(1.1)}
    .tab-btn.active{background:var(--lf-orange);color:#111}

    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

    label{display:flex;flex-direction:column;gap:6px;font-weight:600;color:#0f172a}
    input,select,textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline: none;
      transition:border-color .2s, box-shadow .2s;
      background:#fff;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--lf-blue);
      box-shadow:0 0 0 3px rgba(0,76,109,.15);
    }
    textarea{resize:vertical}

    button{
      cursor:pointer;border:none;padding:10px 14px;border-radius:10px;
      font-weight:700;transition:.2s;
    }
    .btn-primary{background:var(--lf-orange);color:#111}
    .btn-primary:hover{filter:brightness(0.95)}
    .btn-ghost{background:transparent;border:2px solid var(--lf-blue);color:var(--lf-blue)}
    .btn-ghost:hover{background:var(--lf-blue);color:#fff}

    .kpi .big{font-size:24px;font-weight:800;color:var(--lf-blue)}

    .muted{color:var(--muted);font-size:12px}
    .empty{
      display:flex;align-items:center;justify-content:center;
      border:2px dashed var(--border);border-radius:12px;padding:22px;color:var(--muted)
    }
    .eta-out{font-weight:700;margin-top:8px}

    .list{display:grid;gap:8px}
    .check-item{display:flex;gap:8px;align-items:center;font-weight:600;color:#0f172a}
    .check-item input{width:auto}

    @media (max-width: 768px){
      .app-header h1{font-size:16px}
      .tabs{flex-direction:column}
      .tab-btn{width:100%;text-align:center}
    }

    #scanner-container {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
      display: none;
    }

    #scanner-container.active {
      display: block;
    }

    #scanner-video {
      display: block;
      width: 100%;
      max-height: 300px;
      background: #000;
    }

    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 200px;
      border: 3px solid var(--lf-orange);
      border-radius: 12px;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
      animation: scanner-pulse 2s infinite;
    }

    @keyframes scanner-pulse {
      0% { border-color: var(--lf-orange); }
      50% { border-color: #ffcc66; }
      100% { border-color: var(--lf-orange); }
    }

    .scanner-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 12px;
    }

    .table-resumo {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    .table-resumo th, .table-resumo td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .table-resumo th {
      background-color: var(--lf-blue);
      color: white;
    }
    
    .table-resumo tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: var(--bg);
    }

    .login-card {
      background: var(--card);
      border-radius: 14px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .login-logo {
      text-align: center;
      margin-bottom: 24px;
    }

    .login-logo .logo {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--lf-blue);
      font-weight: bold;
      font-size: 24px;
      margin: 0 auto 12px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .user-type-selector {
      display: flex;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .user-type-btn {
      flex: 1;
      padding: 12px;
      background: var(--border);
      border: none;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
    }

    .user-type-btn.active {
      background: var(--lf-blue);
      color: white;
    }

    .admin-panel {
      background: #f1f5f9;
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .data-table th, .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .data-table th {
      background-color: var(--lf-blue);
      color: white;
    }

    .data-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .filter-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-controls select, .filter-controls input {
      min-width: 150px;
    }
    
    .offline-badge {
      background: #f44336;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .online-badge {
      background: #4caf50;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }

    .nfe-info {
      background-color: #f0f9ff;
      border-left: 4px solid var(--lf-blue);
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      display: none;
    }
    
    .nfe-info.visible {
      display: block;
    }
    
    .nfe-info p {
      margin: 4px 0;
      font-size: 14px;
    }
    
    .nfe-info .label {
      font-weight: 600;
      color: var(--lf-blue);
    }
  </style>
</head>
<body>
  <!-- Tela de Login -->
  <div id="loginScreen" class="login-container">
    <div class="login-card">
      <div class="login-logo">
        <div class="logo">LF</div>
        <h2>LF Transportes</h2>
        <p class="muted">Fa√ßa login para continuar</p>
        <div id="connectionStatus" class="offline-badge">Modo Offline</div>
      </div>

      <div class="user-type-selector">
        <button type="button" class="user-type-btn active" data-user-type="driver">Motorista</button>
        <button type="button" class="user-type-btn" data-user-type="admin">Administrador</button>
      </div>

      <form id="loginForm" class="login-form">
        <label>
          Usu√°rio
          <input type="text" id="loginUser" required placeholder="Digite seu usu√°rio" />
        </label>
        
        <label>
          Senha
          <input type="password" id="loginPassword" required placeholder="Digite sua senha" />
        </label>
        
        <button type="submit" class="btn-primary">Entrar</button>
      </form>

      <p class="muted" style="text-align: center; margin-top: 16px;">
        Dica: Use "motorista"/"motorista" ou "admin"/"admin" para teste
      </p>
    </div>
  </div>

  <!-- Aplica√ß√£o -->
  <div id="appContainer" style="display: none;">
    <header class="app-header">
      <div class="brand">
        <div class="logo" style="display:flex;align-items:center;justify-content:center;color:var(--lf-blue);font-weight:bold">LF</div>
        <h1>LF Transportes ‚Ä¢ App de Coleta</h1>
      </div>
      <div class="row">
        <span class="badge" id="userBadge">Motorista</span>
        <span id="appConnectionStatus" class="offline-badge">Offline</span>
        <button class="btn-ghost" onclick="logout()" style="color: white; border-color: white;">Sair</button>
      </div>
    </header>

    <div class="container">
      <!-- Navega√ß√£o -->
      <nav class="tabs" aria-label="Navega√ß√£o de abas" id="mainTabs">
        <button class="tab-btn active" data-tab="dash">Dashboard</button>
        <button class="tab-btn" data-tab="check">Checklist</button>
        <button class="tab-btn" data-tab="nf">Cadastrar NF</button>
        <button class="tab-btn" data-tab="eta">ETA</button>
        <button class="tab-btn" data-tab="sum">Resumo</button>
        <button class="tab-btn" data-tab="admin" id="adminTab" style="display: none;">Admin</button>
      </nav>

      <!-- DASHBOARD -->
      <section id="dash" class="tab card" style="display:block;">
        <div class="card-title">
          <h2>üìä Dashboard</h2>
          <div class="row">
            <label>De: <input type="date" id="filtroInicio" /></label>
            <label>At√©: <input type="date" id="filtroFim" /></label>
            <button class="btn-primary" onclick="exportNFs()">Exportar CSV</button>
          </div>
        </div>
        <div id="dashCards" class="grid grid-3"></div>
      </section>

      <!-- CHECKLIST -->
      <section id="check" class="tab card" style="display:none;">
        <h2>‚úÖ Checklist</h2>
        <div id="checklist" class="list">
          <label class="check-item"><input type="checkbox" /> Pneus calibrados</label>
          <label class="check-item"><input type="checkbox" /> Luzes funcionando</label>
          <label class="check-item"><input type="checkbox" /> Lacres conferidos</label>
          <label class="check-item"><input type="checkbox" /> Documentos em m√£os</label>
        </div>
      </section>

      <!-- CADASTRAR NF -->
      <section id="nf" class="tab card" style="display:none;">
        <h2>üßæ Cadastrar Nota Fiscal</h2>
        
        <!-- Scanner Section -->
        <div class="row">
          <button class="btn-primary" id="btScannerNF" style="display: flex; align-items: center; gap: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 7V5C4 4.44772 4.44772 4 5 4H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 17V19C4 19.5523 4.44772 20 5 20H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 17H22C22.5523 17 23 17.4477 23 18V20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M20 7H22C22.5523 7 23 6.55228 23 6V4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <rect x="1" y="1" width="22" height="22" rx="3" stroke="currentColor" stroke-width="2"/>
              <path d="M8 10H16V14H8V10Z" fill="currentColor"/>
            </svg>
            Escanear NF
          </button>
        </div>
        
        <div id="scanner-container">
          <div class="scanner-overlay">
            <div class="scanner-frame"></div>
          </div>
          <video id="scanner-video"></video>
          <div class="scanner-controls">
            <button class="btn-ghost" id="btStopScanner">Parar Scanner</button>
          </div>
        </div>
        
        <!-- Informa√ß√µes da NF-e detectada -->
        <div id="nfeInfo" class="nfe-info">
          <p><span class="label">NF-e detectada:</span> <span id="nfeNumber"></span></p>
          <p><span class="label">Chave de acesso:</span> <span id="nfeKey"></span></p>
          <p><span class="label">Data de emiss√£o:</span> <span id="nfeDate"></span></p>
          <p><span class="label">CNPJ Emitente:</span> <span id="nfeCNPJ"></span></p>
        </div>
        
        <div class="grid grid-2" style="margin-top:10px">
          <div class="card">
            <h3>Dados b√°sicos</h3>
            <label>N√∫mero NF <input id="nfNumero" /></label>
            <label>Data/Hora coleta <input id="nfDataHora" type="datetime-local" /></label>
            <label>Remetente <input id="nfRem" /></label>
            <label>Destinat√°rio <input id="nfDest" /></label>
            <div class="grid grid-2">
              <label>Volumes <input id="nfVolumes" type="number" min="0" /></label>
              <label>Peso (kg) <input id="nfPeso" type="number" step="0.01" min="0" /></label>
            </div>
            <div class="grid grid-2">
              <label>m¬≥ <input id="nfM3" type="number" step="0.01" min="0" /></label>
              <label>Rota
                <select id="nfRota">
                  <option>Fortaleza</option>
                  <option>Bel√©m</option>
                  <option>Manaus</option>
                  <option>Boa Vista</option>
                  <option>Outra</option>
                </select>
              </label>
            </div>
            <label>Respons√°vel <input id="nfResp" /></label>
            <label>Observa√ß√µes <textarea id="nfObs" rows="3"></textarea></label>
            <button class="btn-primary" id="btSalvarNF">Salvar NF</button>
          </div>
        </div>
      </section>

      <!-- ETA -->
      <section id="eta" class="tab card" style="display:none;">
        <h2>‚è±Ô∏è ETA</h2>
        <div class="grid grid-3 compact-grid">
          <label>Partida <input id="etaPartida" type="datetime-local" /></label>
          <label>Dura√ß√£o (min) <input id="etaMin" type="number" min="1" /></label>
          <div class="row">
            <button class="btn-primary" id="btCalcETA">Calcular</button>
            <button class="btn-ghost" id="btSalvarETA">Salvar ETA</button>
          </div>
        </div>
        <p id="etaOut" class="eta-out">‚Äî</p>
      </section>

      <!-- RESUMO -->
      <section id="sum" class="tab card" style="display:none;">
        <h2>üßæ Resumo</h2>
        <div id="sumResumo"></div>
      </section>

      <!-- ADMIN PANEL -->
      <section id="admin" class="tab card" style="display:none;">
        <h2>üë®‚Äçüíº Painel Administrativo</h2>
        
        <div class="filter-controls">
          <label>
            Rota
            <select id="adminFilterRota">
              <option value="">Todas</option>
              <option>Fortaleza</option>
              <option>Bel√©m</option>
              <option>Manaus</option>
              <option>Boa Vista</option>
              <option>Outra</option>
            </select>
          </label>
          
          <label>
            Data In√≠cio
            <input type="date" id="adminFilterDataInicio" />
          </label>
          
          <label>
            Data Fim
            <input type="date" id="adminFilterDataFim" />
          </label>
          
          <button class="btn-primary" onclick="applyAdminFilters()">Aplicar Filtros</button>
          <button class="btn-ghost" onclick="clearAdminFilters()">Limpar Filtros</button>
          <button class="btn-primary" onclick="syncWithServer()" id="syncButton">Sincronizar com Servidor</button>
        </div>
        
        <div class="admin-panel">
          <h3>Relat√≥rio de NFs</h3>
          <div id="adminReport"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== CONFIGURA√á√ïES E VARI√ÅVEIS GLOBAIS =====
    const SUPABASE_URL = "https://vqefwcpbzuhcfkrzaxic.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhbmFzZSIsInJlZiI6InZxZWZ3Y3BienVoY2ZrcnpheGljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NDY5MjAsImV4cCI6MjA3MjUyMjkyMH0.wbnbfxZuR7bRahQfBpsDDErk8vAiWQOortnzNmyR8prU";

    // Chaves para localStorage
    const LS = { 
      nfs: 'lf_nfs', 
      admin: 'lf_admin',
      user: 'lf_user',
      userType: 'lf_user_type',
      pendingSync: 'lf_pending_sync'
    };

    // Vari√°veis globais
    let nfs = [];
    let scannerActive = false;
    let videoStream = null;
    let scanningInterval = null;
    let currentUserType = 'driver';
    let currentUser = '';
    let isOnline = false;
    let supabase = null;

    // Fun√ß√µes utilit√°rias
    function loadLS(key, fallback) { 
      try { 
        return JSON.parse(localStorage.getItem(key)) ?? fallback; 
      } catch(e) { 
        return fallback; 
      } 
    }

    function saveLS(key, val) { 
      localStorage.setItem(key, JSON.stringify(val)); 
    }

    function isMobile() {
      return /Mobi|Android/i.test(navigator.userAgent);
    }

    function isAdmin() {
      return currentUserType === 'admin';
    }

    function checkOnlineStatus() {
      isOnline = navigator.onLine;
      const statusElement = document.getElementById('connectionStatus');
      const appStatusElement = document.getElementById('appConnectionStatus');
      
      if (statusElement) {
        statusElement.textContent = isOnline ? 'Online' : 'Offline';
        statusElement.className = isOnline ? 'online-badge' : 'offline-badge';
      }
      
      if (appStatusElement) {
        appStatusElement.textContent = isOnline ? 'Online' : 'Offline';
        appStatusElement.className = isOnline ? 'online-badge' : 'offline-badge';
      }
      
      return isOnline;
    }

    // ===== PROCESSADOR DE CHAVE DE ACESSO NF-e =====
    function processarChaveNFE(chave) {
      // Verificar se √© uma chave de acesso v√°lida (44 d√≠gitos)
      if (!chave || chave.length !== 44 || !/^\d+$/.test(chave)) {
        return null;
      }
      
      try {
        // Extrair informa√ß√µes da chave de acesso (formato padr√£o NF-e)
        const uf = chave.substring(0, 2);
        const anoMes = chave.substring(2, 6);
        const cnpj = chave.substring(6, 20);
        const modelo = chave.substring(20, 22);
        const serie = chave.substring(22, 25);
        const numeroNF = chave.substring(25, 34);
        const codigoNumerico = chave.substring(34, 43);
        const digitoVerificador = chave.substring(43, 44);
        
        // Mapeamento de UF (c√≥digos IBGE)
        const ufMap = {
          '12': 'AC', '27': 'AL', '16': 'AP', '13': 'AM', '29': 'BA',
          '23': 'CE', '53': 'DF', '32': 'ES', '52': 'GO', '21': 'MA',
          '51': 'MT', '50': 'MS', '31': 'MG', '15': 'PA', '25': 'PB',
          '41': 'PR', '26': 'PE', '22': 'PI', '24': 'RN', '43': 'RS',
          '33': 'RJ', '11': 'RO', '14': 'RR', '42': 'SC', '35': 'SP',
          '28': 'SE', '17': 'TO'
        };
        
        return {
          chave: chave,
          uf: ufMap[uf] || uf,
          ano: '20' + anoMes.substring(0, 2),
          mes: anoMes.substring(2, 4),
          cnpj: cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5'),
          modelo: modelo,
          serie: serie,
          numero: numeroNF.replace(/^0+/, ''), // Remove zeros √† esquerda
          codigoNumerico: codigoNumerico,
          digitoVerificador: digitoVerificador
        };
      } catch (error) {
        console.error('Erro ao processar chave de acesso:', error);
        return null;
      }
    }

    // ===== EXIBIR INFORMA√á√ïES DA NF-e =====
    function exibirInfoNFE(dadosNFE) {
      const nfeInfo = document.getElementById('nfeInfo');
      document.getElementById('nfeNumber').textContent = dadosNFE.numero;
      document.getElementById('nfeKey').textContent = dadosNFE.chave;
      document.getElementById('nfeDate').textContent = `${dadosNFE.mes}/${dadosNFE.ano}`;
      document.getElementById('nfeCNPJ').textContent = dadosNFE.cnpj;
      nfeInfo.classList.add('visible');
      
      // Preencher automaticamente o campo de n√∫mero da NF
      document.getElementById('nfNumero').value = dadosNFE.numero;
      
      // Se a UF for conhecida, tentar preencher a rota automaticamente
      if (dadosNFE.uf === 'AM') {
        document.getElementById('nfRota').value = 'Manaus';
      } else if (dadosNFE.uf === 'PA') {
        document.getElementById('nfRota').value = 'Bel√©m';
      } else if (dadosNFE.uf === 'RR') {
        document.getElementById('nfRota').value = 'Boa Vista';
      } else if (dadosNFE.uf === 'CE') {
        document.getElementById('nfRota').value = 'Fortaleza';
      }
    }

    // ===== SISTEMA DE LOGIN =====
    async function setupLogin() {
      // Verificar status de conex√£o
      checkOnlineStatus();
      window.addEventListener('online', checkOnlineStatus);
      window.addEventListener('offline', checkOnlineStatus);
      
      // Tentar inicializar Supabase apenas se estivermos online
      if (isOnline) {
        try {
          console.log("Tentando conectar com Supabase...");
          const supabaseModule = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
          supabase = supabaseModule.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("Supabase inicializado com sucesso");
  
          // Teste a conex√£o (corrigido)
          const { count, error } = await supabase
            .from('usuarios')
            .select('*', { count: 'exact', head: true });
            
          if (error) {
            console.error("Erro ao testar conex√£o:", error);
            isOnline = false;
          } else {
            console.log("Conex√£o testada com sucesso. Total de usu√°rios:", count);
          }
        } catch (error) {
          console.error("Erro ao carregar Supabase:", error);
          isOnline = false;
          checkOnlineStatus();
        }
      }
      
      // Verificar se j√° est√° logado
      const savedUser = localStorage.getItem(LS.user);
      const savedUserType = localStorage.getItem(LS.userType);
      
      if (savedUser && savedUserType) {
        currentUser = savedUser;
        currentUserType = savedUserType;
        showApp();
        return;
      }
      
      // Configurar seletor de tipo de usu√°rio
      document.querySelectorAll('.user-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.user-type-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      // Configurar formul√°rio de login
      document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const usuario = document.getElementById('loginUser').value.trim();
        const senha = document.getElementById('loginPassword').value.trim();
        const userType = document.querySelector('.user-type-btn.active').dataset.userType;
        
        console.log("Tentando login com:", { usuario, senha, userType });

        // Se estivermos online, tentar autenticar com Supabase
        if (isOnline && supabase) {
          try {
            // CONSULTA CORRIGIDA - use 'usuario' em vez de 'e-mail'
            const { data, error } = await supabase
              .from('usuarios')
              .select('*')
              .eq('usuario', usuario) // ou 'email' dependendo da sua tabela
              .eq('senha', senha)
              .eq('tipo', userType)
              .eq('ativo', true)
              .maybeSingle();

            console.log("Resultado Supabase:", { data, error });

            if (error) {
              console.error('Erro do Supabase:', error);
              // Fallback para login local em caso de erro
              useLocalLogin(usuario, senha, userType);
              return;
            }

            if (!data) {
              alert('Usu√°rio, senha ou tipo incorretos, ou usu√°rio inativo.');
              return;
            }

            // Login bem-sucedido
            currentUser = data.usuario;
            currentUserType = data.tipo;

            localStorage.setItem(LS.user, currentUser);
            localStorage.setItem(LS.userType, currentUserType);

            showApp();
            return;
          } catch (error) {
            console.error('Erro na autentica√ß√£o:', error);
            // Fallback para login local em caso de erro
            useLocalLogin(usuario, senha, userType);
            return;
          }
        }
        
        // Se offline ou Supabase n√£o dispon√≠vel, usar login local
        useLocalLogin(usuario, senha, userType);
      });
    }

    // Login local (fallback)
    function useLocalLogin(usuario, senha, userType) {
      if ((usuario === 'motorista' && senha === 'motorista' && userType === 'driver') || 
          (usuario === 'admin' && senha === 'admin' && userType === 'admin')) {
        currentUser = usuario;
        currentUserType = userType;
        
        localStorage.setItem(LS.user, currentUser);
        localStorage.setItem(LS.userType, currentUserType);
        
        showApp();
      } else {
        alert('Credenciais inv√°lidas. Use "motorista"/"motorista" para motorista ou "admin"/"admin" para administrador.');
      }
    }

    // ===== MOSTRAR APP =====
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      
      // Atualizar interface baseada no tipo de usu√°rio
      document.getElementById('userBadge').textContent = isAdmin() ? 'Administrador' : 'Motorista';
      
      // Controle de abas por tipo de usu√°rio
      const adminTab = document.getElementById('adminTab');
      const dashTab = document.querySelector('.tab-btn[data-tab="dash"]');
      
      if (isAdmin()) {
        adminTab.style.display = 'block';
        dashTab.style.display = 'block';
        renderAdminPanel();
      } else {
        // Para motoristas, esconder dashboard e admin
        adminTab.style.display = 'none';
        dashTab.style.display = 'none';
        
        // Se a aba ativa for dashboard, mudar para cadastro de NF
        if (document.querySelector('.tab-btn.active').dataset.tab === 'dash') {
          document.querySelector('.tab-btn[data-tab="nf"]').click();
        }
      }
      
      // Inicializar a aplica√ß√£o
      initApp();
    }

    // ===== LOGOUT =====
    function logout() {
      localStorage.removeItem(LS.user);
      localStorage.removeItem(LS.userType);
      
      document.getElementById('appContainer').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      
      // Limpar formul√°rio de login
      document.getElementById('loginForm').reset();
    }

    // ===== NAVEGA√á√ÉO =====
    function setupNavigation() {
      // Abas
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          
          // Esconder todas as abas
          document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
          
          // Mostrar a aba selecionada
          document.getElementById(tab).style.display = 'block';
          
          // Atualizar bot√µes ativos
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Atualizar conte√∫do espec√≠fico da aba
          if (tab === 'dash') renderDashboardCards();
          if (tab === 'sum') atualizarResumo();
          if (tab === 'admin') renderAdminPanel();
        });
      });
    }

    // ===== DASHBOARD =====
    function renderDashboardCards() {
      const container = document.getElementById("dashCards");
      if (!container) return;

      container.innerHTML = "";

      // Modo simplificado no celular para motoristas
      if (isMobile() && !isAdmin()) {
        container.innerHTML = "<p class='muted'>üì± Use a aba <b>Cadastrar NF</b> para adicionar novas notas fiscais.</p>";
        return;
      }

      if (!nfs || !nfs.length) {
        container.innerHTML = "<div class='empty'>Nenhuma NF cadastrada ainda. V√° em <b>Cadastrar NF</b> para adicionar.</div>";
        return;
      }

      // Agrupar por rota
      const agrupado = {};
      nfs.forEach(nf => {
        const rota = nf.rota || 'Outra';
        if (!agrupado[rota]) {
          agrupado[rota] = {
            qtd: 0,
            volumes: 0,
            peso: 0,
            m3: 0,
            nfs: []
          };
        }
        
        agrupado[rota].qtd += 1;
        agrupado[rota].volumes += Number(nf.volumes || 0);
        agrupado[rota].peso += Number(nf.peso || 0);
        agrupado[rota].m3 += Number(nf.m3 || 0);
        agrupado[rota].nfs.push(nf);
      });

      // Criar cards
      for (const rota in agrupado) {
        const dados = agrupado[rota];
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${rota}</h3>
          <div class="kpi"><span class="big">${dados.qtd}</span> NFs</div>
          <div class="kpi"><span class="big">${dados.volumes}</span> Volumes</div>
          <div class="kpi"><span class="big">${dados.peso.toFixed(2)}</span> kg</div>
          <div class="kpi"><span class="big">${dados.m3.toFixed(2)}</span> m¬≥</div>
        `;
        container.appendChild(card);
      }
    }

    // ===== CADASTRO DE NF =====
    function salvarNF() {
      const nf = {
        numero: document.getElementById("nfNumero").value.trim(),
        datahora: document.getElementById("nfDataHora").value,
        rem: document.getElementById("nfRem").value.trim(),
        dest: document.getElementById("nfDest").value.trim(),
        volumes: Number(document.getElementById("nfVolumes").value||0),
        peso: Number(document.getElementById("nfPeso").value||0),
        m3: Number(document.getElementById("nfM3").value||0),
        rota: document.getElementById("nfRota").value,
        resp: document.getElementById("nfResp").value.trim(),
        obs: document.getElementById("nfObs").value.trim(),
        usuario: currentUser,
        dataRegistro: new Date().toISOString()
      };
      
      if(!nf.numero){ 
        alert("Informe n√∫mero da NF"); 
        return; 
      }
      
      nfs.unshift(nf);
      saveLS(LS.nfs, nfs);
      
      // Se estiver online, tentar sincronizar com o servidor
      if (isOnline && supabase) {
        syncNFWithServer(nf);
      } else {
        // Se offline, armazenar para sincroniza√ß√£o posterior
        const pendingSync = loadLS(LS.pendingSync, []);
        pendingSync.push(nf);
        saveLS(LS.pendingSync, pendingSync);
      }
      
      renderDashboardCards();
      atualizarResumo();
      
      if (isAdmin()) {
        renderAdminPanel();
      }
      
      alert("NF salva!");
      
      // Limpar campos
      ["nfNumero","nfDataHora","nfRem","nfDest","nfVolumes","nfPeso","nfM3","nfResp","nfObs"].forEach(id=>{
        const el = document.getElementById(id); 
        if (el) el.value = "";
      });
      
      // Esconder informa√ß√µes da NF-e
      document.getElementById('nfeInfo').classList.remove('visible');
    }

    // Sincronizar NF com servidor
    async function syncNFWithServer(nf) {
      if (!supabase) return false;
      
      try {
        const { data, error } = await supabase
          .from('notas_fiscais')
          .insert([nf]);
          
        if (error) {
          console.error('Erro ao sincronizar NF:', error);
          // Salvar para tentar novamente depois
          const pendingSync = loadLS(LS.pendingSync, []);
          pendingSync.push(nf);
          saveLS(LS.pendingSync, pendingSync);
          return false;
        }
        
        console.log('NF sincronizada com sucesso:', data);
        return true;
      } catch (error) {
        console.error('Erro ao sincronizar NF:', error);
        // Salvar para tentar novamente depois
        const pendingSync = loadLS(LS.pendingSync, []);
        pendingSync.push(nf);
        saveLS(LS.pendingSync, pendingSync);
        return false;
      }
    }

    // ===== ETA =====
    function calcularETA() {
      const partida = new Date(document.getElementById("etaPartida").value);
      const minutos = Number(document.getElementById("etaMin").value);
      
      if(!partida.getTime() || !minutos){ 
        alert("Preencha partida e dura√ß√£o"); 
        return; 
      }
      
      const chegada = new Date(partida.getTime() + minutos * 60000);
      const chegadaStr = chegada.toLocaleString("pt-BR");
      
      document.getElementById("etaOut").textContent = chegadaStr;
    }

    function salvarETA() {
      const partida = document.getElementById("etaPartida").value;
      const minutos = document.getElementById("etaMin").value;
      const chegada = document.getElementById("etaOut").textContent;
      
      if(chegada === "‚Äî"){ 
        alert("Calcule o ETA primeiro"); 
        return; 
      }
      
      const eta = { partida, minutos, chegada, usuario: currentUser, data: new Date().toISOString() };
      const etas = loadLS('lf_etas', []);
      etas.unshift(eta);
      saveLS('lf_etas', etas);
      
      alert("ETA salvo!");
    }

    // ===== RESUMO =====
    function atualizarResumo() {
      const container = document.getElementById("sumResumo");
      if (!container) return;
      
      if (!nfs || !nfs.length) {
        container.innerHTML = "<div class='empty'>Nenhuma NF cadastrada ainda.</div>";
        return;
      }
      
      // Agrupar por rota
      const agrupado = {};
      nfs.forEach(nf => {
        const rota = nf.rota || 'Outra';
        if (!agrupado[rota]) {
          agrupado[rota] = {
            qtd: 0,
            volumes: 0,
            peso: 0,
            m3: 0
          };
        }
        
        agrupado[rota].qtd += 1;
        agrupado[rota].volumes += Number(nf.volumes || 0);
        agrupado[rota].peso += Number(nf.peso || 0);
        agrupado[rota].m3 += Number(nf.m3 || 0);
      });
      
      let html = '<table class="table-resumo">';
      html += '<tr><th>Rota</th><th>NFs</th><th>Volumes</th><th>Peso (kg)</th><th>m¬≥</th></tr>';
      
      for (const rota in agrupado) {
        const dados = agrupado[rota];
        html += `<tr>
          <td>${rota}</td>
          <td>${dados.qtd}</td>
          <td>${dados.volumes}</td>
          <td>${dados.peso.toFixed(2)}</td>
          <td>${dados.m3.toFixed(2)}</td>
        </tr>`;
      }
      
      html += '</table>';
      container.innerHTML = html;
    }

    // ===== SCANNER =====
    async function iniciarScanner() {
      // Esconder informa√ß√µes anteriores
      document.getElementById('nfeInfo').classList.remove('visible');
      
      // Verificar suporte a BarcodeDetector
      if (!('BarcodeDetector' in window)) {
        alert("Seu navegador n√£o suporta leitura de c√≥digos de barras. Use um navegador moderno como Chrome ou Edge.");
        return;
      }
      
      try {
        const video = document.getElementById("scanner-video");
        const container = document.getElementById("scanner-container");
        
        videoStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        video.srcObject = videoStream;
        container.classList.add("active");
        scannerActive = true;
        
        // Iniciar detec√ß√£o de c√≥digo de barras
        // Tentar usar datamatrix se dispon√≠vel
        const formatos = ['qr_code', 'ean_13', 'code_128', 'data_matrix'];
        const barcodeDetector = new BarcodeDetector({ formats });
        
        scanningInterval = setInterval(async () => {
          if (!scannerActive) return;
          
          try {
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length > 0) {
              const barcode = barcodes[0];
              const rawValue = barcode.rawValue;
              
              // Verificar se √© uma chave de acesso de NF-e (44 d√≠gitos)
              const dadosNFE = processarChaveNFE(rawValue);
              
              if (dadosNFE) {
                // √â uma NF-e - exibir informa√ß√µes adicionais
                document.getElementById("nfNumero").value = dadosNFE.numero;
                exibirInfoNFE(dadosNFE);
              } else {
                // √â um c√≥digo de barras comum
                document.getElementById("nfNumero").value = rawValue;
              }
              
              pararScanner();
            }
          } catch (err) {
            console.error("Erro na detec√ß√£o:", err);
          }
        }, 500);
        
      } catch (err) {
        console.error("Erro ao acessar c√¢mera:", err);
        alert("N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.");
      }
    }

    function pararScanner() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      
      if (scanningInterval) {
        clearInterval(scanningInterval);
        scanningInterval = null;
      }
      
      scannerActive = false;
      
      const container = document.getElementById("scanner-container");
      if (container) container.classList.remove("active");
    }

    // ===== PAINEL ADMIN =====
    function renderAdminPanel() {
      const container = document.getElementById("adminReport");
      if (!container) return;
      
      if (!nfs || !nfs.length) {
        container.innerHTML = "<div class='empty'>Nenhuma NF cadastrada ainda.</div>";
        return;
      }
      
      // Aplicar filtros
      const rotaFiltro = document.getElementById("adminFilterRota").value;
      const dataInicio = document.getElementById("adminFilterDataInicio").value;
      const dataFim = document.getElementById("adminFilterDataFim").value;
      
      const nfsFiltradas = nfs.filter(nf => {
        // Filtrar por rota
        if (rotaFiltro && nf.rota !== rotaFiltro) return false;
        
        // Filtrar por data
        if (dataInicio || dataFim) {
          const dataNF = new Date(nf.dataRegistro);
          const inicio = dataInicio ? new Date(dataInicio) : null;
          const fim = dataFim ? new Date(dataFim + 'T23:59:59') : null;
          
          if (inicio && dataNF < inicio) return false;
          if (fim && dataNF > fim) return false;
        }
        
        return true;
      });
      
      if (!nfsFiltradas.length) {
        container.innerHTML = "<div class='empty'>Nenhuma NF encontrada com os filtros aplicados.</div>";
        return;
      }
      
      // Gerar relat√≥rio
      let html = '<table class="data-table">';
      html += '<tr><th>N√∫mero</th><th>Data/Hora</th><th>Remetente</th><th>Destinat√°rio</th><th>Volumes</th><th>Peso</th><th>Rota</th><th>Usu√°rio</th></tr>';
      
      nfsFiltradas.forEach(nf => {
        html += `<tr>
          <td>${nf.numero}</td>
          <td>${new Date(nf.datahora).toLocaleString('pt-BR')}</td>
          <td>${nf.rem}</td>
          <td>${nf.dest}</td>
          <td>${nf.volumes}</td>
          <td>${nf.peso} kg</td>
          <td>${nf.rota}</td>
          <td>${nf.usuario}</td>
        </tr>`;
      });
      
      html += '</table>';
      container.innerHTML = html;
    }

    function applyAdminFilters() {
      renderAdminPanel();
    }

    function clearAdminFilters() {
      document.getElementById("adminFilterRota").value = "";
      document.getElementById("adminFilterDataInicio").value = "";
      document.getElementById("adminFilterDataFim").value = "";
      renderAdminPanel();
    }

    // ===== SINCRONIZA√á√ÉO =====
    async function syncWithServer() {
      if (!isOnline || !supabase) {
        alert("N√£o √© poss√≠vel sincronizar. Verifique sua conex√£o com a internet.");
        return;
      }
      
      // Sincronizar NFs pendentes
      const pendingSync = loadLS(LS.pendingSync, []);
      const successfulSyncs = [];
      
      for (let i = 0; i < pendingSync.length; i++) {
        const nf = pendingSync[i];
        const success = await syncNFWithServer(nf);
        
        if (success) {
          successfulSyncs.push(i);
        }
      }
      
      // Remover as NFs que foram sincronizadas com sucesso
      if (successfulSyncs.length > 0) {
        const newPendingSync = pendingSync.filter((_, index) => !successfulSyncs.includes(index));
        saveLS(LS.pendingSync, newPendingSync);
      }
      
      // Recarregar dados do servidor
      await loadNfsFromServer();
      
      alert(`Sincroniza√ß√£o conclu√≠da. ${successfulSyncs.length} NFs sincronizadas.`);
    }

    async function loadNfsFromServer() {
      if (!isOnline || !supabase) return;
      
      try {
        const { data, error } = await supabase
          .from('notas_fiscais')
          .select('*')
          .order('dataRegistro', { ascending: false });
          
        if (error) {
          console.error('Erro ao carregar NFs do servidor:', error);
          return;
        }
        
        if (data && data.length > 0) {
          nfs = data;
          saveLS(LS.nfs, nfs);
          renderDashboardCards();
          atualizarResumo();
          renderAdminPanel();
        }
      } catch (error) {
        console.error('Erro ao carregar NFs do servidor:', error);
      }
    }

    // ===== EXPORTA√á√ÉO =====
    function exportNFs() {
      if (!nfs || !nfs.length) {
        alert("Nenhuma NF para exportar");
        return;
      }
      
      let csv = "N√∫mero,Data/Hora,Remetente,Destinat√°rio,Volumes,Peso (kg),m¬≥,Rota,Respons√°vel,Observa√ß√µes\n";
      
      nfs.forEach(nf => {
        csv += `"${nf.numero}","${new Date(nf.datahora).toLocaleString('pt-BR')}","${nf.rem}","${nf.dest}",${nf.volumes},${nf.peso},${nf.m3},"${nf.rota}","${nf.resp}","${nf.obs}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `nfs_lf_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ===== INICIALIZA√á√ÉO =====
    function initApp() {
      // Carregar dados
      nfs = loadLS(LS.nfs, []);
      
      // Configurar navega√ß√£o
      setupNavigation();
      
      // Configurar eventos
      document.getElementById("btSalvarNF").addEventListener("click", salvarNF);
      document.getElementById("btCalcETA").addEventListener("click", calcularETA);
      document.getElementById("btSalvarETA").addEventListener("click", salvarETA);
      document.getElementById("btScannerNF").addEventListener("click", iniciarScanner);
      document.getElementById("btStopScanner").addEventListener("click", pararScanner);
      
      // Configurar data/hora atual como padr√£o
      const now = new Date();
      const nowStr = now.toISOString().slice(0, 16);
      document.getElementById("nfDataHora").value = nowStr;
      document.getElementById("etaPartida").value = nowStr;
      
      // Inicializar visualiza√ß√µes
      renderDashboardCards();
      atualizarResumo();
      
      // Se estiver online, tentar carregar dados do servidor
      if (isOnline && supabase) {
        loadNfsFromServer();
      }
    }

    // Inicializar quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', setupLogin);
  </script>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
async function iniciarScanner() {
  document.getElementById('nfeInfo').classList.remove('visible');

  if ('BarcodeDetector' in window) {
    try {
      const video = document.getElementById("scanner-video");
      const container = document.getElementById("scanner-container");

      videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = videoStream;
      container.classList.add("active");
      scannerActive = true;

      const detector = new BarcodeDetector({ formats: ['qr_code','code_128','ean_13','data_matrix'] });
      scanningInterval = setInterval(async () => {
        const codes = await detector.detect(video);
        if (codes.length > 0) {
          processarCodigo(codes[0].rawValue);
        }
      }, 500);
    } catch (e) {
      alert("Erro ao acessar c√¢mera: " + e.message);
    }
  } else {
    const container = document.getElementById("scanner-container");
    container.classList.add("active");

    Quagga.init({
      inputStream: { type : "LiveStream", target: container },
      decoder : { readers : ["code_128_reader","ean_reader","ean_13_reader","upc_reader"] }
    }, err => {
      if (err) { console.error(err); return }
      Quagga.start();
    });

    Quagga.onDetected(res => {
      const code = res.codeResult.code;
      if (code) processarCodigo(code);
    });
  }
}

function processarCodigo(rawValue){
  const dadosNFE = processarChaveNFE(rawValue);
  if (dadosNFE) {
    document.getElementById("nfNumero").value = dadosNFE.numero;
    exibirInfoNFE(dadosNFE);
  } else {
    document.getElementById("nfNumero").value = rawValue;
  }
  pararScanner();
}
</script>
</body>

</html>
